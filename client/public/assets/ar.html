<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script src="./aframe-master.min.js"></script>
    <script src="./aframe-ar-nft.js"></script>
    <link rel="stylesheet" type="text/css" href="./ar-style.css" />
  </head>

  <script>
    let btnTimeOut;
    let lastFoundMarker = 0;
    let lastFoundMarkerType = '';
    // marker detection event handlers
    AFRAME.registerComponent('markerhandler', {
      init: function () {
        let marker = this.el;

        // reset stuff when marker is lost
        marker.addEventListener('markerLost', function () {
          clearTimeout(btnTimeOut); // TODO doesnt work yet
          var markerId = marker.id;
          // collectButton.classList.add('--hidden');
          // document.querySelector('.interaction-message').textContent = '';
        });

        // TODO: does this need to be in aframe register function?
        const m0 = document.querySelector('.triangulis0');
        const m1 = document.querySelector('.triangulis1');
        const m2 = document.querySelector('.triangulis2');
        const m3 = document.querySelector('.triangulis3');
        const kleineStadt = document.querySelector('.kleine-stadt');
        const einzeller = document.querySelector('.einzeller');
        const uhr1 = document.querySelector('.uhr1');
        const uhr2 = document.querySelector('.uhr2');
        const uhr3 = document.querySelector('.uhr3');
        const uhr4 = document.querySelector('.uhr4');
        const wurmloch = document.querySelector('.wurmloch');
        const m11 = document.querySelector('.musikpflanze');
        const mask1 = document.querySelector('.maskA');
        const mask2 = document.querySelector('.maskB');
        const klo = document.querySelector('.bilderrahmen');

        // ----------- marker trigger event listeners -----------
        m0.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'normal';
          console.log('heyy');
          lastFoundMarker = 0;
          triggerOverlay('Triangulis');
        });
        // triangulis interaktion entry
        m1.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'i';
          lastFoundMarker = 31;
          triggerOverlay('..?');
        });
        // triangulis interaktion
        m2.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'i';
          lastFoundMarker = 32;
          triggerOverlay('..!');
        });
        // triangulis interaktion
        m3.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'normal';
          lastFoundMarker = 1;
          triggerOverlay('Ihr habt es geschafft');
        });
        kleineStadt.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'normal';
          lastFoundMarker = 4;
          triggerOverlay('cyber stadt');
        });
        einzeller.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'normal';
          lastFoundMarker = 3;
          triggerOverlay('einzeller');
        });
        // 4 muss man sammeln bevor das item gesammelt wird
        uhr1.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'u';
          lastFoundMarker = 0;
          triggerOverlay('Uhr 1');
        });
        uhr2.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'u';
          lastFoundMarker = 1;
          triggerOverlay('Uhr 2');
        });
        uhr3.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'u';
          lastFoundMarker = 2;
          triggerOverlay('Uhr 3');
        });
        uhr4.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'u';
          lastFoundMarker = 3;
          triggerOverlay('tick tack');
        });
        klo.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'normal';
          lastFoundMarker = 7;
          triggerOverlay('bilderrahmen beim klo');
        });
        m11.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'normal';
          lastFoundMarker = 6;
          triggerOverlay('pflanze gustav');
        });
        mask1.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'm';
          lastFoundMarker = 0;
          triggerOverlay('maske a');
          // entweder in AR oder in overlay 3 siebe an text anlegen
        });
        mask2.addEventListener('markerFound', () => {
          lastFoundMarkerType = 'm';
          lastFoundMarker = 1;
          triggerOverlay('maske b');
          // entweder in AR oder in overlay 3 siebe an text anlegen
        });
        // // chakren kann man in beliebiger reihenfolge sammeln, das letzte zeigt dann die zusammenfassung
        // m14.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 0;
        //   triggerOverlay('chakra 1');
        // });
        // m15.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 1;
        //   triggerOverlay('chakra 2');
        // });
        // m16.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 2;
        //   triggerOverlay('chakra 3');
        // });
        // m17.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 3;
        //   triggerOverlay('chakra 4');
        // });
        // m18.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 4;
        //   triggerOverlay('chakra 5');
        // });
        // m19.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 5;
        //   triggerOverlay('chakra 6');
        // });
        // m20.addEventListener('markerFound', () => {
        //   lastFoundMarkerType = 'chakra';
        //   lastFoundMarker = 6;
        //   triggerOverlay('chakra 7');
        // });
      },
    });

    //sends currently found marker from collect button
    // const collectItem = () => {
    //   window.parent.postMessage(
    //     lastFoundMarkerType + ' ' + lastFoundMarker,
    //     '*'
    //   );
    // };
  </script>

  <body style="margin: 0px; overflow: hidden">
    <div class="top-overlay no-opacity">
      <!-- <img src="./text-deco.jpg" alt="" /> -->
      <span class="interaction-message">...</span>
      <!-- <img class="flipped-corner" src="./text-deco.jpg" alt="" /> -->
      <!-- <button class="collect-button" onclick="collectItem()">sammeln</button> -->
    </div>

    <a-scene
      class="camera-scene"
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      embedded
    >
      <!-- 0 - triangulis marker einfach -->
      <a-marker markerhandler type="barcode" value="0" class="triangulis0">
      </a-marker>
      <!-- triangulis kopianer marker 1-3 -->
      <a-marker markerhandler type="barcode" value="1" class="triangulis1">
      </a-marker>
      <!-- weitere marker werden in overlays angezeigt -->
      <a-marker markerhandler type="barcode" value="31" class="triangulis2">
      </a-marker>
      <a-marker markerhandler type="barcode" value="32" class="triangulis3">
      </a-marker>
      <a-marker markerhandler type="barcode" value="3" class="wurmloch">
      </a-marker>
      <!-- 4 - kleine stadt (calvin) -->
      <a-marker markerhandler type="barcode" value="4" class="kleine-stadt">
      </a-marker>

      <!-- 5 - großer einzeller -->
      <a-marker markerhandler type="barcode" value="9" class="einzeller">
      </a-marker>

      <!-- 6-8 - fraktale uhren (lazaro) -->
      <a-marker markerhandler type="barcode" value="6" class="uhr1"> </a-marker>
      <a-marker markerhandler type="barcode" value="7" class="uhr2"> </a-marker>
      <a-marker markerhandler type="barcode" value="8" class="uhr3"> </a-marker>
      <!-- 9 - uhr 4 -->
      <a-marker markerhandler type="barcode" value="5" class="uhr4"> </a-marker>
      <!-- 99 - Wasserfall -->
      <a-marker markerhandler type="barcode" value="99" class="wasserfall">
      </a-marker>
      <!-- 10 - bilderrahmen am toilettenhäuschen -->
      <a-marker markerhandler type="barcode" value="10" class="bilderrahmen">
      </a-marker>
      <!-- 11 - pflanze aufm boden -->
      <a-marker markerhandler type="barcode" value="11" class="musikpflanze">
      </a-marker>

      <a-marker markerhandler type="barcode" value="13" class="maskA">
      </a-marker>
      <a-marker markerhandler type="barcode" value="14" class="maskB">
      </a-marker>

      <!-- Define the camera of the scene -->
      <a-camera position="0 0 0"> </a-camera>
    </a-scene>

    <script>
      // const collectButton = document.querySelector('.collect-button');
      // const overlayBanner = document.querySelector('.top-overlay');

      function triggerOverlay(text) {
        window.parent.postMessage(
          lastFoundMarkerType + ' ' + lastFoundMarker,
          '*'
        );
      }
      // const sceneEl = document.querySelector('.camera-scene');
      // sceneEl.addEventListener('render-target-loaded', function () {
      //   // sceneEl.renderer is now set.
      // });
    </script>
  </body>
</html>
